# LED-Control
**Multiplexing, dimming &amp; color mixing of RGBW LEDs**

This project has been an educational exercise that attempts to combine multiplexing and pulse width modulation to control the color and dimming of an array of RGBW LEDs without needing a separate PWM signal for every color of every LED. I've made the basic concept work, and now I'm reorganizing the project and using it to get familiarized with GitHub and some other software development tools.

I began programming the project in the Arduino IDE, but I've since converted it into C in Visual Studio Code, using command line tools (gcc and avrdude) for compiling and downloading code to the Arduino Uno. This is to avoid the simplified interface of the Arduino IDE and learn some software tools and skills that might be more broadly useful for embedded programming.

**Hardware:**

<p>
    <img src="/images/LED Controller schematic-page-001.jpg" />
</p>

Common-anode RGBW LED strip lights are used as the LEDs shown in the schematic. Each strip has its anode connected to power by a high side p-channel MOSFET switch, while four low side n-channel MOSFETs switch all cathodes of the same color to ground. A particular color of a particular strip only turns on when that strip is powered by the high side switch *and* that color's cathode is grounded by the low side switch; this allows every color of every strip to be controlled individually with a minimum of outputs from the Arduino.

Four Arduino outputs control a shift register, whose outputs drive the high side MOSFETs, and four more outputs provide PWM signals for the four low side MOSFETs. Currently only six LED strips are connected to the shift register's outputs, but two more could be added (or even more if another shift register is added) without needing any more outputs from the Arduino.

The four PWM signals are synchronized and operate at the same frequency (7.8kHz), and the LED strips are turned on one at a time, switching from one to the next at the same frequency as the PWM signals. The result is each LED strip stays powered for the duration of a single PWM period; then it is switched off, the PWM duty cycles are changed, and the next LED strip is powered on as the next PWM cycle begins.

This is the first project I've done that involves high(ish) speed MOSFET switching, so that's been another good educational experience. I built discrete BJT gate driver circuits for the six p-channel MOSFETs. A gate driver IC might be a more efficient choice here, but designing the discrete circuits was a good exercise.

<p>
    <img src="/images/Breadboard photo.jpg" />
</p>

**Software:**

A timer driven interrupt handles switching between LED strips and updating the PWM duty cycle values. A lookup table (implemented as a 2D array) holds the duty cycle values for each color of each LED strip, and the ISR reads the values from this table. Consequently, changing a value in this table results in an immediate change in the color of the corresponding LED strip.

While the periodic interrupts keep the LED colors updated per the table, the program's main routine can change the values in the table to create lighting effects. Developing a method to generate these effects is the next part of the project that needs work. Currently a rainbow swirl effect is generated by initializing the table to a set of starting values and then entering a loop that conditionally increments or decrements each value. I might just see how many other effects I can figure out how to generate with this type of algorithm-based approach.

Another method I've tinkered with is creating a 3D lookup table containing a series of table states that can be played back like frames of an animation. This method is simple to implement in software, but using Excel to generate the lookup tables themselves gets pretty tedious pretty quickly.
